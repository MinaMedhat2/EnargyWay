@page "/user-dashboard"
@attribute [Authorize(Roles = "User")]
@layout UserLayout

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient Http
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager

@* ============================================================================== *@
@* =================== تصميم "The Modern Storefront" - HTML فقط =================== *@
@* ============================================================================== *@

<div class="storefront-container">

    @* --- 1. شريط التنقل --- *@
    <header class="storefront-header">
        <a class="header-brand" href="/user-dashboard">
            <i class="fas fa-gas-pump"></i>
            <span>Oil Depot</span>
        </a>
        <nav class="header-nav">
            <NavLink href="/user-dashboard" Match="NavLinkMatch.All" class="nav-link">Home</NavLink>
            <NavLink href="/products" class="nav-link">Shop</NavLink>
            <NavLink href="/deals" class="nav-link">Deals</NavLink>
            <NavLink href="/about" class="nav-link">About Us</NavLink>
        </nav>
        <div class="header-actions">
            <a href="/cart" class="action-btn">
                <i class="fas fa-shopping-bag"></i>
                <span class="badge">3</span>
            </a>
            @if (userIsAuthenticated)
            {
                <div class="user-menu">
                    <button class="action-btn profile-btn">
                        <i class="fas fa-user"></i>
                    </button>
                    <div class="user-dropdown">
                        <div class="dropdown-header">Welcome, @userName</div>
                        <a href="/profile" class="dropdown-item">My Profile</a>
                        <a href="/orders" class="dropdown-item">My Orders</a>
                        <button @onclick="HandleLogout" class="dropdown-item logout">Logout</button>
                    </div>
                </div>
            }
        </div>
    </header>

    @* --- 2. المحتوى الرئيسي --- *@
    <main class="storefront-main">
        <div class="hero-banner">
            <h1>Premium Industrial Lubricants</h1>
            <p>Unmatched quality and performance for all your needs.</p>
            <button class="hero-button">Shop Now</button>
        </div>

        <div class="products-showcase">
            <div class="showcase-header">
                <h2>Our Bestsellers</h2>
                <a href="/products" class="view-all-link">View All <i class="fas fa-arrow-right"></i></a>
            </div>

            @if (products == null)
            {
                <div class="loading-state">Loading our finest products...</div>
            }
            else
            {
                <div class="products-grid-storefront">
                    @foreach (var product in products)
                    {
                        <div class="product-card-storefront">
                            <div class="card-image-container">
                                <img src="@(ApiBaseUrl + "/" + product.ImagePath.Replace("\\", "/"))" alt="@product.Name" />
                                <div class="card-overlay">
                                    <button class="overlay-button">Quick View</button>
                                </div>
                            </div>
                            <div class="card-details">
                                <span class="card-category">Industrial Oil</span>
                                <h3 class="card-title">@product.Name</h3>
                                <div class="card-price-container">
                                    <span class="card-price">@product.Price.ToString("C")</span>
                                </div>
                                <button class="add-to-cart-button">Add to Cart</button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </main>

    @* --- 3. التذييل --- *@
    <footer class="storefront-footer">
        <p>&copy; @DateTime.Now.Year Oil Depot. All Rights Reserved.</p>
    </footer>
</div>

@* --- استدعاء خط Inter من Google Fonts --- *@
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

@code {
    // ... كود الـ C# الرائع الذي بنيته يبقى كما هو بدون أي تغيير ...
    private string? userName;
    private bool userIsAuthenticated = false;
    private List<Product>? products;
    private string? ApiBaseUrl;

    protected override async Task OnInitializedAsync()
    {
        ApiBaseUrl = Configuration["ApiBaseUrl"] ?? "https://localhost:7185";
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity is { IsAuthenticated: true })
        {
            userIsAuthenticated = true;
            userName = user.Identity.Name;
        }
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await Http.GetFromJsonAsync<List<Product>>($"{ApiBaseUrl}/api/Products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading products: {ex.Message}");
            products = new List<Product>();
        }
    }

    private void HandleLogout()
    {
        NavigationManager.NavigateTo("/logout", forceLoad: true);
    }

    public class Product
    {
        public int ProductID { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Price { get; set; }
        public string ImagePath { get; set; } = "";
    }
}
